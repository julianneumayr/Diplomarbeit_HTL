import serial
import serial.tools.list_ports
from settings import BAUD_RATE, PID, VID


def light_capture():
    def find_serial_device(vid, pid):
        for port in serial.tools.list_ports.comports():
            if port.vid == vid and port.pid == pid:
                return port.device
        return None

    found_port = find_serial_device(VID, PID)

    if found_port is None:
        return -1

    else:
        ser = serial.Serial(found_port, BAUD_RATE)

        try:
            raw_data = ser.read(200).splitlines()[1]
            values = [float(i) for i in raw_data.decode().strip().split(",")]
            average_intensity = sum(values) / len(values)
            print(average_intensity)
            return int(average_intensity)
        except Exception:
            return -2
        finally:
            ser.close()
