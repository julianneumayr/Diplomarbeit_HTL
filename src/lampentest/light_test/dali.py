import os
import socket
import time

from settings import DALI_BROADCAST_ADDRESS, DALI_TURN_OFF, DALI_TURN_ON

# install daliserver with "dpkg -i daliserver.deb"
# from https://github.com/onitake/daliserver/


# Use A3 + value as command for register
# Use FE + value to go to brightness
"""
Most important commands(⁎ send command twice to confirm):
    OFF                             00
    UP                              01      Up one step with fade Rate with dimming no turning on
    DOWN                            02      Down one step with fade Rate with dimming no turning OFF
    STEP UP                         03      Up one step with fade Rate without dimming
    STEP DOWN                       04      Down one step with fade Rate without dimming
    RECALL MAX LEVEL                05      To max level without dimming
    RECALL MIN LEVEL                06      To min level without dimming
    STEP DOWN AND OFF               07      AS STEP DOWN + OFF
    STEP UP AND OFF                 08      AS STEP DOWN + ON
    CONTINUOUS UP                   0B      Up one step with fade Rate with dimming
    CONTINUOUS DOWN                 0C      Up one step with fade Rate with dimming
    GO TO SCENE                     1n      n is scene number 0..F
    RESET                           20⁎
    STORE LIGHT LEVEL in Register   21⁎
    SAVE PERSISTENT VARIABLES       22⁎     lastLightLevel, powerOnLevel, systemFailureLevel, minLevel, MaxLevel
                                            fadeRate, fadeTime, extendedFadeTimeBase, extendedFadeTimeMultiplier
                                            shortAddress, randomAddress, operatingMode, gearGroups
    SET OPERATING MODE              23⁎     via Register: 00..Standard, 01-7F..reserved, 80-FF..manufacturer specific
    RESET MEMORY BANK               24⁎     reset Register
    IDENTIFY DEVICE                 25⁎     Call manufacturer specific ident
    SET MAX LEVEL                   2A⁎     via Register
    SET MIN LEVEL                   2B⁎     via Register
    SET SYSTEM FAILURE LEVEL        2C⁎     via Register; when Bus is interrupted
    SET POWER ON LEVEL              2D⁎     via Register; After external power Cycle
    SET FADE TIME                   2E⁎     via Register; Fade via fade time, if 0 via fade rate; 1..15 in HEX
    SET FADE RATE                   2F⁎     via Register; Fade via fade rate, if 0 via extended fade rate is 0; 0..15 in HEX
    SET EXTENDED FADE TIME          30⁎     via Register; Fade via extended fade time, look up in IEC62386-101 11.4.14
    SET SCENE                       4n⁎     via Register; n is scene number 0..F, save Register brightness to scene
    REMOVE FROM SCENE               5n⁎     n is scene number 0..F, clears brightness in scene n
    ADD TO GROUP                    6n⁎     n is group number 0..F, adds lamp to group
    REMOVE FROM GROUP               7n⁎     n is group number 0..F, removes lamp from group
    SET SHORT ADDRESS               80⁎     via Register; 0ABCDEF1b writes address to 00ABCDEF
"""  # noqa: RUF001
# if fade time = 0 fade rate will be used


def turn_off():
    command = DALI_TURN_OFF
    if send_data(command) == -1:
        return -1
    else:
        print("Ausschaltsignal gesandt!")


def turn_on():
    command = DALI_TURN_ON
    if send_data(command) == -1:
        return -1


def connect_to_daliserver():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(3)
    for _ in range(3):  # Try connecting 3 times
        try:
            s.connect(("127.0.0.1", 55825))
            return s
        except socket.error as e:  # noqa: UP024
            print("Error connecting to DALI server: " + str(e))
            continue

    return None


def send_data(command):
    address = DALI_BROADCAST_ADDRESS  # FF for Broadcast Address starting at 00 with 2 increments: 00 02 04 06...
    s = connect_to_daliserver()
    # if not connected
    if s is None:
        os.system("sudo rm /var/log/daliserver.log")
        os.system("sudo service daliserver restart")
        time.sleep(5)
        s = connect_to_daliserver()
    if s:
        for _ in range(2):
            s.send(bytes.fromhex("02 00") + bytes.fromhex(address) + bytes.fromhex(command))
            print("Command sent!")
        time.sleep(3)
        data = s.recv(1024)
        print(data)
        s.close()
    if s is None:
        return -1
